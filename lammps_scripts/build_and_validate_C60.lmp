# Complete C60 Solvation System Build with Validation and Visualization
# Using TIP4P/2005 water model for realistic solvation
# Optimized for multi-core CPU execution
# Usage: export OMP_NUM_THREADS=12 && lmp_mpi -in build_and_validate_C60.lmp

units real
dimension       3
boundary        p p p
atom_style      full  # Changed to full for charges (TIP4P water)

# =====================================================================
# OpenMP PACKAGE for multi-threading on all cores
# =====================================================================
package         omp 0 neigh yes
# 0 = use OMP_NUM_THREADS environment variable
# neigh yes = threaded neighbor list construction

# Create box for 3 atom types (C60 carbon + water O + water H)
region          mybox block -15 15 -15 15 -15 15
create_box      3 mybox bond/types 2 angle/types 1 &
                extra/bond/per/atom 3 extra/angle/per/atom 6 extra/special/per/atom 12

# Read bonded C60 (60 atoms with 90 bonds, type 1)
# Use "add merge" to merge atom types properly
read_data       C60_bonded.data add merge

# Read TIP4P/2005 water molecule template
# offset: atomtypes bondtypes angletypes dihedraltypes impropertypes
molecule        h2omol H2O_TIP4P2005_fixed.mol offset 1 1 0 0 0

# Define styles (no coefficients yet)
bond_style      harmonic
angle_style     harmonic

# Masses
mass            1 12.011   # C (carbon in C60)
mass            2 15.999   # O (oxygen in water)
mass            3 1.008    # H (hydrogen in water)

# Bond parameters
bond_coeff      1 938.0 1.42      # C-C bonds in C60 (very stiff)
bond_coeff      2 0.0 0.9572      # O-H bonds in water (rigid via SHAKE)

# Angle parameters
angle_coeff     1 0.0 104.52      # H-O-H angle in water (rigid via SHAKE)

# Group C60 atoms
group           c60_group type 1

# Create TIP4P water molecules in sphere (radius 12 Å)
lattice         sc 3.1
region          water_sphere sphere 0 0 0 12 side in
create_atoms    0 region water_sphere mol h2omol 45678 units box

# Group water (O=type 2, H=type 3)
group           water_group type 2 3
group           water_O type 2
group           water_H type 3

# NOW set up TIP4P pair style with kspace (after water molecules exist)
# TIP4P/2005 requires special pair style with M-site (virtual 4th atom)
# Syntax: pair_style lj/cut/tip4p/long/omp Otype Htype bond_type angle_type qdist cutoff
pair_style      lj/cut/tip4p/long/omp 2 3 2 1 0.1546 12.0  # O=type2 H=type3 bond=2 angle=1
kspace_style    pppm/tip4p 1.0e-4

# LJ parameters for C60-water interactions
pair_coeff      1 1 0.07 3.4      # C-C (fullerene): epsilon=0.07 eV, sigma=3.4 Å
pair_coeff      1 2 0.05 3.2      # C-O (C60-water): epsilon=0.05 eV, sigma=3.2 Å
pair_coeff      1 3 0.0 0.0       # C-H (no interaction)
pair_coeff      2 2 0.1852 3.1589 # O-O (TIP4P/2005)
pair_coeff      2 3 0.0 0.0       # O-H (no LJ, only Coulombic)
pair_coeff      3 3 0.0 0.0       # H-H (no LJ, only Coulombic)

# Smart deletion: remove water molecules with O within 7.0 Å of any C60 atom
delete_atoms    overlap 7.0 water_O c60_group mol yes

# Important: don't reset IDs as it can break topology validation

# Count atoms
variable        n_c60 equal count(c60_group)
variable        n_water equal count(water_group)
variable        n_total equal count(all)

print           "========================================"
print           "C60 Solvated System - Build Phase"
print           "========================================"
print           "C60 carbon atoms: ${n_c60}"
print           "Water oxygen atoms: ${n_water}"
print           "Total atoms: ${n_total}"
print           "Box: 30 x 30 x 30 Angstroms"


# Apply SHAKE constraints to water molecules (rigid O-H bonds and H-O-H angle)
fix             water_shake water_group shake 0.0001 20 0 b 2 a 1

# SKIP minimization (incompatible with SHAKE)
# Instead do gentle warm-up from 0K
thermo          50
thermo_style    custom step temp pe ke etotal press

# Gentle warm-up from 1K to 50K over 500 steps (1 ps)
velocity        all create 1.0 87287 loop geom
fix             gentle_warmup all nvt temp 1.0 50.0 100.0
run             500
unfix           gentle_warmup

variable        pe_warmup equal pe
variable        rg_c60 equal gyration(c60_group)

print           "========================================"
print           "Gentle Warm-up Complete"
print           "========================================"
print           "Final PE: ${pe_warmup} kcal/mol"
print           "C60 Rg: ${rg_c60} Angstroms"

# Write initial system (with pair coefficients)
write_data      C60_solvated.data pair ij
write_dump      all xyz C60_solvated_initial.xyz modify element C O H

print           "========================================"
print           "Starting MD Validation (100 ps NVT)"
print           "========================================"

# Initialize velocities (loop geom handles non-consecutive atom IDs)
velocity        all create 300 12345 rot yes dist gaussian loop geom

# FREEZE C60 structure - only water moves
fix             freeze_c60 c60_group setforce 0.0 0.0 0.0
velocity        c60_group set 0.0 0.0 0.0

# NVT dynamics (only water thermostatted)
fix             1 water_group nvt temp 300 300 100.0
timestep        1.0  # 1 fs (real units)

# Output for analysis
thermo          100
thermo_style    custom step temp pe ke etotal press vol density

# Compute properties
compute         rg_c60_compute c60_group gyration
compute         temp_c60 c60_group temp
compute         temp_water water_group temp

# Monitor C60 structure integrity
fix             rg_output all print 100 "$(step*dt/1000) $(c_rg_c60_compute)" file c60_rg.dat screen no title "# Time(ps) Rg(Angstrom)"
fix             temp_output all print 100 "$(step*dt/1000) $(c_temp_c60) $(c_temp_water)" file temperatures.dat screen no title "# Time(ps) T_C60(K) T_water(K)"

# Trajectory for visualization
dump            1 all xyz 100 C60_solvated_md.xyz
dump_modify     1 element C O H

# Run 100 ps (100,000 steps at 1 fs)
run             100000

# Final statistics
variable        rg_final equal gyration(c60_group)
variable        temp_final equal temp
variable        pe_final equal pe

print           "========================================"
print           "MD Validation Complete"
print           "========================================"
print           "Final temperature: ${temp_final} K"
print           "Final C60 Rg: ${rg_final} Angstroms (FROZEN)"
print           "Final PE: ${pe_final} kcal/mol"
print           ""
print           "C60 Structure: INTACT (frozen in place)"
print           "All 90 C-C bonds maintained"

# Write final configuration (with pair coefficients to avoid warning)
write_data      C60_solvated_after_md.data pair ij
write_dump      all xyz C60_solvated_final.xyz modify element C O H

print           "========================================"
print           "Files Created:"
print           "  1. C60_solvated.data - Initial system (bonded C60 + TIP4P water)"
print           "  2. C60_solvated_initial.xyz - Initial structure"
print           "  3. C60_solvated_md.xyz - MD trajectory"
print           "  4. C60_solvated_final.xyz - Final structure"
print           "  5. c60_rg.dat - C60 radius of gyration (constant)"
print           "  6. temperatures.dat - Temperature evolution"
print           "========================================"
print           "C60 Structure: FROZEN and BONDED"
print           "Ready for solvation studies!"
print           "========================================"
