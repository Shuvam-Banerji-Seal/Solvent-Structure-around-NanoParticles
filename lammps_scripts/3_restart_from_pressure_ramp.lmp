    # LAMMPS Restart Script: Continue from Pressure Ramp Checkpoint
# Purpose: Restart NPT equilibration and production after MSD fix
# Created: Auto-generated after fixing MSD compute syntax error
#
# This script continues from pressure_ramp_complete.restart
# It will:
#   1. Complete NPT equilibration (1000 ps total)
#   2. Run production MD (4000 ps)

# ===== INITIALIZATION =====
units real
atom_style full
boundary p p p
atom_modify map array

# ===== COMMUNICATION =====
comm_modify cutoff 18.0

# ===== READ RESTART FILE =====
# This continues from the end of Stage 2 (Pressure Ramp)
read_restart pressure_ramp_complete.restart

# ===== FORCE FIELD (FULLY GPU-accelerated) =====
pair_style lj/cut/tip4p/long/gpu 2 3 2 1 0.1546 12.0
# ğŸ”§ CRITICAL: Use pppm/gpu for FULL GPU acceleration of Coulomb forces
kspace_style pppm/gpu 1.0e-4
kspace_modify mesh 50 50 50
kspace_modify order 5
kspace_modify force/disp/real 0.8

bond_style harmonic
angle_style harmonic

# ===== PAIR COEFFICIENTS =====
# Get epsilon_co from command line
variable epsilon_co equal ${EPSILON_CO}

pair_coeff 1 1 0.07 3.4            # C-C
pair_coeff 2 2 0.1852 3.1589       # O-O
pair_coeff 3 3 0.0 0.0             # H-H
pair_coeff 1 2 ${epsilon_co} 3.2   # C-O (variable)
pair_coeff 1 3 0.0 0.0             # C-H
pair_coeff 2 3 0.0 0.0             # O-H

# Bond and angle coefficients
bond_coeff 1 938.0 1.42         # C-C bonds in C60
bond_coeff 2 0.0 0.9572         # O-H bonds (SHAKE controlled)
angle_coeff 1 0.0 104.52        # H-O-H angle (SHAKE controlled)

# ===== SETTINGS =====
neighbor 2.0 bin
neigh_modify delay 5 every 1 check yes

# Define groups
group carbon type 1
group water type 2 3
group oxygen type 2
group hydrogen type 3

# Apply SHAKE
fix myshk water shake 0.0001 20 0 b 2 a 1

# Define thermodynamic variables
variable temp equal c_thermo_temp
variable press equal c_thermo_press
variable pe equal pe
variable ke equal ke
variable etotal equal etotal
variable vol equal vol
variable dens equal density

thermo_style custom step temp press vol pe ke etotal density
thermo 1000

timestep 2.0

print "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
print "RESTARTING FROM PRESSURE RAMP CHECKPOINT"
print "  Epsilon (O-C): ${epsilon_co} kcal/mol"
print "  Continuing from: Step 100,010 (end of pressure ramp)"
print "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
print ""

#==============================================================================
# STAGE 3: NPT Equilibration (Complete 1000 ps from beginning)
#==============================================================================
print "===== STAGE 3: NPT Equilibration (1000 ps, GPU) ====="
print "Equilibrating at 300K, 1 atm with improved pressure control"
print ""
print "Strategy:"
print "  Phase 1 (400 ps): Higher damping for gentle pressure equilibration"
print "  Phase 2 (600 ps): Standard damping for final equilibration"
print ""

# Phase 1: Gentle NPT with stronger pressure damping (400 ps)
print "Phase 1: Gentle pressure equilibration (400 ps, pdamp=5000)..."
# ğŸ”§ CRITICAL: Using npt/gpu instead of npt for FULL GPU acceleration
fix mynpt_gentle all npt/gpu temp 300.0 300.0 100.0 iso 1.0 1.0 5000.0

dump npt_traj all custom 2000 npt_equilibration.lammpstrj id type xu yu zu
dump_modify npt_traj sort id

dump npt_dcd all dcd 2000 npt_equilibration.dcd
dump_modify npt_dcd unwrap yes

# Thermodynamic averaging during NPT (same as main script)
fix thermo_avg_npt all ave/time 100 10 1000 v_epsilon_co v_temp v_press v_pe v_ke v_etotal v_vol v_dens &
    file npt_equilibration_thermo.dat

run 200000  # 400 ps at 2 fs timestep

unfix mynpt_gentle

variable phase1_dens equal density
variable phase1_press equal press
print ""
print "Phase 1 complete:"
print "  Density:  ${phase1_dens} g/cmÂ³"
print "  Pressure: ${phase1_press} atm"
print ""

# Phase 2: Standard NPT damping (600 ps)
print "Phase 2: Final equilibration (600 ps, pdamp=2000)..."
# ğŸ”§ CRITICAL: Using npt/gpu instead of npt for FULL GPU acceleration
fix mynpt_standard all npt/gpu temp 300.0 300.0 100.0 iso 1.0 1.0 2000.0

run 300000  # 600 ps at 2 fs timestep

undump npt_traj
undump npt_dcd
unfix mynpt_standard
unfix thermo_avg_npt

write_restart npt_complete.restart
write_data npt_complete.data

# CRITICAL: Save NPT checkpoint for production restart capability
write_restart npt_equilibration_complete.restart
write_data npt_equilibration_complete.data

variable current_dens equal density
variable current_vol equal vol
variable current_press equal press
variable current_temp equal temp
print ""
print "NPT equilibration complete (1000 ps total):"
print "  Temperature: ${current_temp} K"
print "  Density:     ${current_dens} g/cmÂ³"
print "  Pressure:    ${current_press} atm"
print "  Volume:      ${current_vol} Ã…Â³"
print ""
print "âœ… CHECKPOINT: NPT equilibration complete"
print "   Files saved:"
print "     - npt_complete.restart (legacy name)"
print "     - npt_equilibration_complete.restart (for production restart)"
print "     - npt_equilibration_complete.data (structure file)"
print "     - npt_equilibration_thermo.dat (thermodynamics)"
print ""

# Checkpoint: Verify density
if "${current_dens} < 0.85 || ${current_dens} > 1.15" then &
    "print 'ERROR: Density outside expected range (0.85-1.15 g/cmÂ³)'" &
    "print 'Current density: ${current_dens} g/cmÂ³'" &
    "quit 1"

print "âœ“ Density validation PASSED: ${current_dens} g/cmÂ³"
print ""

#==============================================================================
# STAGE 4: Production MD (4000 ps = 4 ns)
#==============================================================================
print ""
print "===== STAGE 4: Production MD (4000 ps = 4 ns, GPU) ====="
print "Main data collection phase - RDF, MSD, trajectories"
print ""
print "Pressure control strategy:"
print "  â€¢ Using MTK barostat for better ensemble accuracy"
print "  â€¢ Tdamp = 100 fs (standard for NosÃ©-Hoover)"
print "  â€¢ Pdamp = 1000 fs (tighter control for stable production)"
print ""

# Production NPT with MTK barostat and tighter pressure control
# Using smaller pdamp (1000 fs vs 2000 fs) for more stable pressure
# ğŸ”§ CRITICAL: Using npt/gpu instead of npt for FULL GPU acceleration
fix mynpt all npt/gpu temp 300.0 300.0 100.0 iso 1.0 1.0 1000.0 mtk yes

# Main trajectory dump (every 1 ps for analysis)
dump prod_traj all custom 1000 production.lammpstrj id type xu yu zu
dump_modify prod_traj sort id

# DCD dump (every 0.5 ps for smooth visualization)
dump prod_dcd all dcd 500 production.dcd
dump_modify prod_dcd unwrap yes

# Detailed thermodynamics (every 1 ps)
fix thermo_avg all ave/time 100 10 1000 v_epsilon_co v_temp v_press v_pe v_ke v_etotal v_vol v_dens     file production_thermo.dat

# Very detailed thermodynamics (every 0.1 ps for fluctuation analysis)
fix thermo_detailed all ave/time 10 10 100 v_temp v_press v_pe v_ke v_vol v_dens     file production_detailed_thermo.dat

# Compute RDFs on-the-fly (C60-water, C60-C60, water-water)
compute rdf_CO all rdf 150 1 2  # C-O pairs (C60-water)
compute rdf_CC all rdf 150 1 1  # C-C pairs (C60-C60)
compute rdf_OO all rdf 150 2 2  # O-O pairs (water-water)

# Average RDFs over production run (every 10 ps)
# FIXED: Explicit column indexing (RDF outputs [1]=r, [2]=g(r), [3]=coordination)
fix rdf_CO_avg all ave/time 1000 10 10000 c_rdf_CO[1] c_rdf_CO[2] c_rdf_CO[3] file rdf_CO.dat mode vector
fix rdf_CC_avg all ave/time 1000 10 10000 c_rdf_CC[1] c_rdf_CC[2] c_rdf_CC[3] file rdf_CC.dat mode vector
fix rdf_OO_avg all ave/time 1000 10 10000 c_rdf_OO[1] c_rdf_OO[2] c_rdf_OO[3] file rdf_OO.dat mode vector

# Compute MSD for water oxygen (diffusion analysis)
compute msd_water oxygen msd
# FIXED: MSD compute outputs: [1]=dxÂ², [2]=dyÂ², [3]=dzÂ², [4]=total rÂ²
fix msd_avg all ave/time 100 10 1000 c_msd_water[1] c_msd_water[2] c_msd_water[3] c_msd_water[4] file msd_water.dat

# Progress monitoring
variable prod_step equal step-600010
print ""
print "Production MD starting from step 600,010..."
print "Target: 2,000,000 steps (4000 ps)"
print ""

# Run production (4000 ps = 2,000,000 steps)
run 2000000

# Cleanup
undump prod_traj
undump prod_dcd
unfix mynpt
unfix thermo_avg
unfix thermo_detailed
unfix rdf_CO_avg
unfix rdf_CC_avg
unfix rdf_OO_avg
unfix msd_avg

write_restart production_complete.restart
write_data production_complete.data

print ""
print "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
print "SIMULATION COMPLETE!"
print "  Total simulation time: 5.2 ns"
print "  Epsilon: ${epsilon_co} kcal/mol"
print "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
